<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mars Shooter</title>
<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#000;
}
canvas{display:block}
#hud{
  position:fixed;
  top:10px;
  left:10px;
  color:#0ff;
  font-family:monospace;
  font-size:14px;
  background:rgba(0,0,0,.5);
  padding:6px 10px;
  border-radius:4px;
}
</style>
</head>
<body>

<div id="hud">
CH <span id="ch">1</span> |
SCORE <span id="score">0</span> |
HP <span id="hp">100</span>
</div>

<canvas id="game"></canvas>

<script>
/* ================= 기본 ================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener('resize', resize);

/* ================= 이미지 ================= */
const IMG = {};
[
  'bg_mars1','bg_mars2',
  'player',
  'enemy_straight','enemy_zigzag','enemy_sniper',
  'boss1','boss2','boss3',
  'item_bullets','item_shield','item_bomb'
].forEach(k=>{
  IMG[k] = new Image();
  IMG[k].src = `assets/${k}.png`;
});

/* ================= 배경 ================= */
let bgY = 0;
let bgIndex = 0;
const BG_LIST = ['bg_mars1','bg_mars2'];
const bgSpeed = 1.4;

function drawBackground(){
  bgY += bgSpeed;
  if(bgY >= canvas.height){
    bgY = 0;
    bgIndex = (bgIndex + 1) % BG_LIST.length;
  }
  const cur = IMG[BG_LIST[bgIndex]];
  const next = IMG[BG_LIST[(bgIndex+1)%BG_LIST.length]];
  ctx.drawImage(cur, 0, bgY - canvas.height, canvas.width, canvas.height);
  ctx.drawImage(next, 0, bgY, canvas.width, canvas.height);
}

/* ================= 게임 상태 ================= */
let chapter = 1;
let score = 0;
let hp = 100;

const player = {
  x: canvas.width/2,
  y: canvas.height - 120,
  power: 1,
  bulletTimer: 0,
  shield: 0,
  shieldTimer: 0
};

let bullets = [];
let enemies = [];
let items = [];
let boss = null;

/* ================= 입력 ================= */
addEventListener('mousemove', e=>{
  player.x = e.clientX;
  player.y = e.clientY;
});
addEventListener('touchmove', e=>{
  player.x = e.touches[0].clientX;
  player.y = e.touches[0].clientY;
  e.preventDefault();
},{passive:false});

/* ================= 아이템 드랍 ================= */
function tryDropItem(x,y){
  if(Math.random() > 0.02) return;
  const r = Math.random();
  let type = 'item_bullets';
  if(r > 0.9) type = 'item_bomb';
  else if(r > 0.45) type = 'item_shield';
  items.push({x,y,type});
}

/* ================= 적 생성 ================= */
function spawnEnemy(){
  let type = 'enemy_straight';
  const r = Math.random();
  if(r > 0.66) type = 'enemy_sniper';
  else if(r > 0.33) type = 'enemy_zigzag';

  enemies.push({
    x: Math.random()*canvas.width,
    y: -60,
    type,
    t: 0,
    speed: 2 + chapter
  });
}

/* ================= 보스 ================= */
function spawnBoss(){
  boss = {
    x: canvas.width/2,
    y: 120,
    hp: 600 * chapter,
    img: IMG[`boss${chapter}`]
  };
}

/* ================= 루프 ================= */
let last = 0;
function loop(t){
  const d = t - last;
  last = t;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawBackground();

  /* 타이머 */
  if(player.power > 1){
    player.bulletTimer -= d;
    if(player.bulletTimer <= 0) player.power = 1;
  }
  if(player.shield > 0){
    player.shieldTimer -= d;
    if(player.shieldTimer <= 0) player.shield = 0;
  }

  /* 총알 */
  bullets = bullets.filter(b=>{
    b.y -= 12;
    ctx.fillStyle = '#0ff';
    ctx.fillRect(b.x-2,b.y-10,4,10);
    return b.y > -20;
  });

  /* 자동 발사 */
  if(Math.random() < 0.15){
    for(let i=0;i<player.power;i++){
      bullets.push({
        x: player.x + (i-(player.power-1)/2)*12,
        y: player.y
      });
    }
  }

  /* 적 */
  if(!boss && Math.random() < 0.03) spawnEnemy();

  enemies = enemies.filter(e=>{
    e.t++;
    if(e.type === 'enemy_straight') e.y += e.speed;
    if(e.type === 'enemy_zigzag'){
      e.y += e.speed;
      e.x += Math.sin(e.t*0.1)*4;
    }
    if(e.type === 'enemy_sniper') e.y += e.speed*1.5;

    ctx.drawImage(IMG[e.type], e.x-24, e.y-24, 48, 48);

    for(let i=bullets.length-1;i>=0;i--){
      if(Math.hypot(bullets[i].x-e.x, bullets[i].y-e.y) < 26){
        bullets.splice(i,1);
        score += 100;
        tryDropItem(e.x,e.y);
        return false;
      }
    }

    if(Math.hypot(player.x-e.x, player.y-e.y) < 30){
      if(player.shield > 0){
        player.shield -= 20;
      } else {
        hp -= 20;
        if(hp <= 0){
          alert('GAME OVER');
          location.reload();
        }
      }
      return false;
    }
    return e.y < canvas.height+60;
  });

  /* 아이템 */
  items = items.filter(it=>{
    it.y += 2;
    ctx.drawImage(IMG[it.type], it.x-18, it.y-18, 36, 36);
    if(Math.hypot(player.x-it.x, player.y-it.y) < 30){
      if(it.type === 'item_bullets'){
        player.power = Math.min(3, player.power+1);
        player.bulletTimer = 20000;
      }
      if(it.type === 'item_shield'){
        player.shield = hp;
        player.shieldTimer = 30000;
      }
      if(it.type === 'item_bomb'){
        enemies.forEach(()=>score+=100);
        enemies = [];
      }
      return false;
    }
    return it.y < canvas.height+40;
  });

  /* 보스 */
  if(score > chapter*2500 && !boss){
    spawnBoss();
  }

  if(boss){
    ctx.drawImage(boss.img, boss.x-96, boss.y-64, 192, 128);
    bullets.forEach((b,i)=>{
      if(Math.hypot(b.x-boss.x, b.y-boss.y) < 90){
        bullets.splice(i,1);
        boss.hp -= 10;
      }
    });
    if(boss.hp <= 0){
      chapter++;
      boss = null;
      if(chapter > 3){
        alert('MISSION COMPLETE');
        location.reload();
      }
    }
  }

  /* 플레이어 */
  ctx.drawImage(IMG.player, player.x-32, player.y-32, 64, 64);

  /* HUD */
  document.getElementById('score').innerText = score;
  document.getElementById('hp').innerText = hp;
  document.getElementById('ch').innerText = chapter;

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
